; NOTE: Assertions have been autogenerated by utils/update_tpde_llvm_test_checks.py UTC_ARGS: --tool tpde_llvm --default-march x86-64-v2 --filter-out "int3" --version 5
; SPDX-FileCopyrightText: 2024 Tobias Schwarz <tobias.schwarz@tum.de>
;
; SPDX-License-Identifier: LicenseRef-Proprietary

; RUN: tpde_llvm %s | llvm-objdump -d -r --no-show-raw-insn --symbolize-operands --no-addresses --x86-asm-syntax=intel - | FileCheck %s -check-prefixes=X64,CHECK --enable-var-scope --dump-input always


@basic_int = internal dso_local global i32 5, align 4
@basic_array = dso_local global [20 x i32] zeroinitializer, align 16
@more_array = dso_local global [10 x i32] [i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 8, i32 9, i32 10], align 16
@func_ptr = dso_local global ptr @some_func, align 8
@global_ptr = dso_local global ptr getelementptr (i8, ptr @basic_array, i64 16), align 8

declare void @some_func(i32 noundef) #0

define i32 @load_basic_int() {
; X64-LABEL: load_basic_int>:
; X64:    push rbp
; X64:    mov rbp, rsp
; X64:    nop word ptr [rax + rax]
; X64:    sub rsp, 0x30
; X64:    lea rcx, <load_basic_int+0x13>
; X64:     R_X86_64_PC32 basic_int-0x4
; X64:    mov eax, dword ptr [rcx]
; X64:    add rsp, 0x30
; X64:    pop rbp
; X64:    ret
; X64:    add byte ptr [rbp + 0x48], dl
entry:
  %0 = load i32, ptr @basic_int
  ret i32 %0
}

define ptr @load_func_ptr() {
; X64-LABEL: load_func_ptr>:
; X64:    push rbp
; X64:    mov rbp, rsp
; X64:    nop word ptr [rax + rax]
; X64:    sub rsp, 0x30
; X64:    mov rcx, qword ptr <load_func_ptr+0x13>
; X64:     R_X86_64_GOTPCREL func_ptr-0x4
; X64:    mov rax, qword ptr [rcx]
; X64:    add rsp, 0x30
; X64:    pop rbp
; X64:    ret
entry:
  %0 = load ptr, ptr @func_ptr
  ret ptr %0
}

define void @store_global_ptr(ptr %0) {
; X64-LABEL: store_global_ptr>:
; X64:    push rbp
; X64:    mov rbp, rsp
; X64:    nop word ptr [rax + rax]
; X64:    sub rsp, 0x30
; X64:    mov rax, qword ptr <store_global_ptr+0x13>
; X64:     R_X86_64_GOTPCREL global_ptr-0x4
; X64:    mov qword ptr [rax], rdi
; X64:    add rsp, 0x30
; X64:    pop rbp
; X64:    ret
; X64:     ...
entry:
  store ptr %0, ptr @global_ptr
  ret void
}
;; NOTE: These prefixes are unused and the list is autogenerated. Do not add tests below this line:
; CHECK: {{.*}}
